# Chat History Schema v2.0
# Human-readable version of the JSON Schema
# For programmatic validation, use the JSON Schema file

version: "2.0"
schema_type: "chat_history"
description: "Canonical schema for normalized AI chat conversations"

# Root structure
type: object
required:
  - schema_version
  - metadata
  - messages

properties:
  schema_version:
    type: string
    const: "2.0"
    description: "Schema version for migration and validation"
  
  metadata:
    type: object
    description: "Conversation-level metadata"
    required:
      - chat_id
      - platform
      - created_at
      - updated_at
    properties:
      chat_id:
        type: string
        pattern: "^[a-zA-Z0-9_-]+$"
        description: "Unique identifier for the conversation"
        examples:
          - "chat_20251031_123456"
          - "claude-desktop-001"
      
      platform:
        type: string
        description: "Source platform of the conversation"
        enum:
          - claude-desktop
          - claude-web
          - claude-cli
          - chatgpt
          - gemini
          - copilot        # Future platform support
          - perplexity     # Future platform support
          - unknown        # Fallback for unrecognized platforms
      
      exporter:
        type: string
        description: "Tool or method used for export"
        examples:
          - SaveMyChatbot
          - KeepChatGPT
          - manual
          - api
      
      title:
        type: string
        description: "Human-readable conversation title"
      
      created_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp of conversation start"
        example: "2025-10-31T10:00:00Z"
      
      updated_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp of last modification"
      
      exported_at:
        type: string
        format: date-time
        description: "ISO 8601 timestamp of export from platform"
      
      tags:
        type: array
        description: "User-defined tags for categorization"
        items:
          type: string
        examples:
          - ["python", "code-review"]
          - ["architecture", "design"]
      
      session_info:
        type: object
        description: "Session tracking information"
        properties:
          session_id:
            type: string
            description: "Platform-specific session identifier"
          session_continuity:
            type: string
            enum: [new_session, continued_session]
            description: "Whether this continues a previous session"
          parent_session_id:
            type: string
            description: "Previous session ID if continued"
      
      statistics:
        type: object
        description: "Computed statistics about the conversation"
        properties:
          message_count:
            type: integer
            minimum: 0
          word_count:
            type: integer
            minimum: 0
          token_count:
            type: integer
            minimum: 0
            description: "Estimated token count"
          duration_seconds:
            type: number
            minimum: 0
            description: "Duration from first to last message"

      chunking:
        type: object
        description: "Chunking metadata (optional - only present if chat is chunked)"
        required:
          - strategy
          - target_size
          - total_chunks
          - chunk_metadata
        properties:
          strategy:
            type: string
            enum:
              - message_based
              - semantic
              - token_based
            description: "Chunking algorithm used"
            examples:
              - "message_based"

          target_size:
            type: integer
            minimum: 1000
            description: "Soft maximum chunk size in tokens"
            example: 4000

          total_chunks:
            type: integer
            minimum: 1
            description: "Total number of chunks in this conversation"

          chunk_metadata:
            type: array
            description: "Metadata for each chunk"
            items:
              type: object
              required:
                - chunk_id
                - sequence_number
                - message_range
                - token_count
                - timestamp_range
              properties:
                chunk_id:
                  type: string
                  pattern: "^chunk_\\d{3}$"
                  description: "Unique chunk identifier (e.g., chunk_001)"
                  examples:
                    - "chunk_001"
                    - "chunk_002"

                sequence_number:
                  type: integer
                  minimum: 1
                  description: "Chunk order (1-indexed)"

                message_range:
                  type: array
                  description: "Start and end indices in messages array (inclusive)"
                  items:
                    type: integer
                    minimum: 0
                  minItems: 2
                  maxItems: 2
                  examples:
                    - [0, 15]
                    - [16, 32]

                token_count:
                  type: integer
                  minimum: 0
                  description: "Approximate token count for this chunk"

                timestamp_range:
                  type: object
                  description: "Timestamp range for messages in this chunk"
                  required:
                    - start
                    - end
                  properties:
                    start:
                      type: string
                      format: date-time
                      description: "Timestamp of first message in chunk"
                    end:
                      type: string
                      format: date-time
                      description: "Timestamp of last message in chunk"
  
  messages:
    type: array
    description: "Array of conversation messages"
    items:
      type: object
      required:
        - message_id
        - role
        - content
        - timestamp
      properties:
        message_id:
          type: string
          pattern: "^[a-zA-Z0-9_-]+$"
          description: "Unique identifier within the conversation"
          examples:
            - "msg_001"
            - "1730401234567"
        
        role:
          type: string
          enum:
            - user        # Human user input
            - assistant   # AI response
            - system      # System messages/prompts
            - tool        # Tool/function outputs
            - thinking    # Claude thinking blocks (separated from content)
          description: "Message sender role"
        
        content:
          type: string
          description: "Main message content (can be empty for certain types)"
        
        timestamp:
          type: string
          format: date-time
          description: "ISO 8601 timestamp when message was sent"
        
        parent_message_id:
          type: string
          description: "Reference to parent message for conversation branching"
        
        platform_specific:
          type: object
          description: "Platform-specific fields that don't fit common schema"
          additionalProperties: true  # Allow any platform-specific fields
          properties:
            model:
              type: string
              description: "AI model used for response"
              examples:
                - "gpt-4"
                - "claude-3-opus-20240229"
                - "gemini-pro"
            thinking:
              type: string
              description: "Claude thinking/reasoning content if separate"
            tool_calls:
              type: array
              description: "Function or tool invocations"
            original_role:
              type: string
              description: "Original role name if mapped to standard role"
        
        attachments:
          type: array
          description: "File attachments or embedded content"
          items:
            type: object
            required:
              - type
              - name
            properties:
              type:
                type: string
                enum: [file, image, code, artifact, document]
              name:
                type: string
                description: "Filename or identifier"
              content:
                type: string
                description: "Inline content or file reference"
              url:
                type: string
                format: uri
                description: "External URL reference"
              size_bytes:
                type: integer
                minimum: 0
              mime_type:
                type: string
                examples:
                  - "image/png"
                  - "text/plain"
                  - "application/pdf"
              metadata:
                type: object
                additionalProperties: true
        
        metadata:
          type: object
          description: "Message-level metadata"
          additionalProperties: true  # Allow platform extensions
          properties:
            edited:
              type: boolean
            edit_timestamp:
              type: string
              format: date-time
            tokens:
              type: integer
              minimum: 0
            flagged:
              type: boolean
            flag_reason:
              type: string

# Design notes:
# 1. Removed orchestration complexity (participants array) per PianoMan feedback
# 2. Platform field is extensible - add new platforms to enum as needed
# 3. platform_specific allows any platform to add custom fields
# 4. All timestamps use ISO 8601 format for consistency
# 5. message_id and parent_message_id enable conversation branching
# 6. "thinking" role separates Claude's reasoning from responses
# 7. Empty content is allowed for tool responses or system messages